<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dialog - Star Trek Adventures</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: block;
        }
    </style>
    <script src="phaser.min.js"></script>
    <script src="config/dialogConfig.js"></script>
</head>
<body>
    <script>
        // Simple test scene to show Level 2 dialog
        class TestDialogScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestDialogScene' });
                this.levelNumber = 2;
            }
            
            preload() {
                // Create placeholder player ship
                const graphics = this.make.graphics({ x: 0, y: 0, add: false });
                graphics.fillStyle(0x00FFFF, 1);
                graphics.fillRect(0, 0, 32, 32);
                graphics.generateTexture('player-ship', 32, 32);
                graphics.destroy();
            }
            
            create() {
                this.cameraWidth = this.cameras.main.width;
                this.cameraHeight = this.cameras.main.height;
                
                // Add background
                this.add.rectangle(0, 0, this.cameraWidth, this.cameraHeight, 0x001122).setOrigin(0);
                
                // Create player ship in center
                this.playerShip = this.add.sprite(
                    this.cameraWidth / 2,
                    this.cameraHeight / 2,
                    'player-ship'
                );
                
                // Add instruction text
                const instructionText = this.add.text(
                    this.cameraWidth / 2,
                    50,
                    'Press SPACE to show Level 2 intro dialog',
                    {
                        fontSize: '20px',
                        color: '#00FF00',
                        fontFamily: 'Arial, sans-serif',
                        align: 'center'
                    }
                );
                instructionText.setOrigin(0.5);
                
                // Setup keyboard input
                this.input.keyboard.once('keydown-SPACE', () => {
                    this.showCommunication('intro', () => {
                        console.log('Dialog complete!');
                        instructionText.setText('Dialog complete! Press SPACE for outro');
                        this.input.keyboard.once('keydown-SPACE', () => {
                            this.showCommunication('outro', () => {
                                instructionText.setText('All dialogs shown!');
                            });
                        });
                    });
                });
            }
            
            // Copy communication methods from Level1Scene
            showCommunication(trigger, onComplete) {
                console.log(`Showing communication dialog: ${trigger} for level ${this.levelNumber}`);
                
                const dialogData = DialogConfig.getDialog(this.levelNumber, trigger);
                if (!dialogData) {
                    console.warn(`No dialog found for level ${this.levelNumber}, trigger: ${trigger}`);
                    if (onComplete) onComplete();
                    return;
                }

                // Store original player ship scale
                if (this.playerShip) {
                    this.originalPlayerScaleX = this.playerShip.scaleX;
                    this.originalPlayerScaleY = this.playerShip.scaleY;
                    
                    // Scale player ship to 2x size
                    this.tweens.add({
                        targets: this.playerShip,
                        scaleX: DialogConfig.playerShip.communicationScale,
                        scaleY: DialogConfig.playerShip.communicationScale,
                        duration: DialogConfig.playerShip.scaleDuration,
                        ease: 'Sine.easeInOut'
                    });
                    
                    console.log(`Scaling player ship from ${this.originalPlayerScaleX} to ${DialogConfig.playerShip.communicationScale}`);
                }
                
                // Initialize communication state
                this.communicationState = {
                    dialogData: dialogData,
                    currentIndex: 0,
                    onComplete: onComplete,
                    isTyping: false,
                    skipPressed: false,
                    hudElements: null
                };
                
                // Show first message after player ship scaling
                this.time.delayedCall(DialogConfig.playerShip.scaleDuration, () => {
                    this.showNextMessage();
                });
            }

            showNextMessage() {
                const state = this.communicationState;
                if (!state || state.currentIndex >= state.dialogData.sequence.length) {
                    this.closeCommunication();
                    return;
                }

                const message = state.dialogData.sequence[state.currentIndex];
                this.displayCommunicationHUD(message);
            }

            displayCommunicationHUD(message) {
                // Clear previous HUD elements if any
                this.clearCommunicationHUD();

                const isMobile = this.cameraWidth < 600 || this.cameraHeight < 600;
                const config = DialogConfig.hud;
                
                // Calculate dimensions based on device
                const hudWidth = isMobile ? config.mobileWidth : config.width;
                const hudHeight = isMobile ? config.mobileHeight : config.height;
                const portraitSize = isMobile ? config.mobilePortraitSize : config.portraitSize;
                const speakerFontSize = isMobile ? config.mobileSpeakerFontSize : config.speakerFontSize;
                const textFontSize = isMobile ? config.mobileTextFontSize : config.textFontSize;
                const lineHeight = isMobile ? config.mobileLineHeight : config.lineHeight;
                
                // Calculate HUD position
                const cameraWidth = this.cameraWidth || this.cameras.main.width;
                const hudX = isMobile ? Math.max(0, (cameraWidth - hudWidth) / 2) : config.x;
                const hudY = config.y;
                
                // Create container for all HUD elements
                const hudElements = {
                    graphics: [],
                    texts: [],
                    images: []
                };

                // Background panel
                const bg = this.add.graphics();
                bg.setScrollFactor(0);
                bg.setDepth(1000);
                bg.fillStyle(config.backgroundColor, config.backgroundAlpha);
                bg.fillRect(hudX, hudY, hudWidth, hudHeight);
                bg.lineStyle(config.borderWidth, config.borderColor, 1);
                bg.strokeRect(hudX, hudY, hudWidth, hudHeight);
                hudElements.graphics.push(bg);

                // Title bar
                const titleBg = this.add.graphics();
                titleBg.setScrollFactor(0);
                titleBg.setDepth(1000);
                titleBg.fillStyle(config.borderColor, 0.3);
                titleBg.fillRect(hudX, hudY - 25, hudWidth, 25);
                hudElements.graphics.push(titleBg);

                const titleText = this.add.text(
                    hudX + hudWidth / 2,
                    hudY - 12,
                    this.communicationState.dialogData.title || 'COMMUNICATION',
                    {
                        fontSize: '12px',
                        color: '#' + config.borderColor.toString(16).padStart(6, '0'),
                        fontFamily: 'Courier New, monospace',
                        fontStyle: 'bold'
                    }
                );
                titleText.setOrigin(0.5);
                titleText.setScrollFactor(0);
                titleText.setDepth(1001);
                hudElements.texts.push(titleText);

                // Portrait/Ship image (left side)
                const portraitKey = DialogConfig.portraits[message.portrait];
                if (portraitKey && this.textures.exists(portraitKey)) {
                    const portrait = this.add.image(
                        hudX + config.portraitPadding + portraitSize / 2,
                        hudY + hudHeight / 2,
                        portraitKey
                    );
                    // Preserve aspect ratio
                    const texture = portrait.texture;
                    const frame = portrait.frame;
                    const aspectRatio = frame.width / frame.height;
                    
                    if (aspectRatio > 1) {
                        portrait.setDisplaySize(portraitSize, portraitSize / aspectRatio);
                    } else {
                        portrait.setDisplaySize(portraitSize * aspectRatio, portraitSize);
                    }
                    
                    portrait.setScrollFactor(0);
                    portrait.setDepth(1001);
                    hudElements.images.push(portrait);
                } else {
                    // Fallback circle
                    const portraitCircle = this.add.graphics();
                    portraitCircle.setScrollFactor(0);
                    portraitCircle.setDepth(1001);
                    portraitCircle.fillStyle(0x00FFFF, 0.5);
                    portraitCircle.fillCircle(
                        hudX + config.portraitPadding + portraitSize / 2,
                        hudY + hudHeight / 2,
                        portraitSize / 2
                    );
                    hudElements.graphics.push(portraitCircle);
                }

                // Text area (right side)
                const textX = hudX + config.portraitPadding * 2 + portraitSize + config.textPadding;
                const textWidth = hudWidth - portraitSize - config.portraitPadding * 2 - config.textPadding * 2;

                // Speaker name
                const speakerLabel = `${message.speaker}${message.ship ? ` - ${message.ship}` : ''}`;
                const speakerText = this.add.text(
                    textX,
                    hudY + config.textPadding,
                    speakerLabel,
                    {
                        fontSize: speakerFontSize,
                        color: config.speakerColor,
                        fontFamily: config.fontFamily || 'Arial, sans-serif',
                        fontStyle: 'bold',
                        wordWrap: { width: textWidth }
                    }
                );
                speakerText.setScrollFactor(0);
                speakerText.setDepth(1001);
                hudElements.texts.push(speakerText);

                // Dialog text
                const speakerTextGap = isMobile ? (config.mobileSpeakerTextGap || 6) : (config.speakerTextGap || 8);
                const dialogTextY = hudY + config.textPadding + lineHeight + speakerTextGap;
                const dialogText = this.add.text(
                    textX,
                    dialogTextY,
                    message.text,
                    {
                        fontSize: textFontSize,
                        color: config.textColor,
                        fontFamily: config.fontFamily || 'Arial, sans-serif',
                        wordWrap: { width: textWidth },
                        lineSpacing: 4
                    }
                );
                dialogText.setScrollFactor(0);
                dialogText.setDepth(1001);
                hudElements.texts.push(dialogText);

                // Advance prompt
                const advanceText = isMobile ? config.mobileAdvanceText : config.advanceText;
                const advancePrompt = this.add.text(
                    hudX + hudWidth - config.textPadding,
                    hudY + hudHeight - config.textPadding,
                    advanceText,
                    {
                        fontSize: config.advanceFontSize,
                        color: config.advanceColor,
                        fontFamily: 'Courier New, monospace'
                    }
                );
                advancePrompt.setOrigin(1, 1);
                advancePrompt.setScrollFactor(0);
                advancePrompt.setDepth(1001);
                hudElements.texts.push(advancePrompt);

                // Make advance prompt blink
                this.tweens.add({
                    targets: advancePrompt,
                    alpha: 0.3,
                    duration: 500,
                    yoyo: true,
                    repeat: -1
                });

                // Store elements
                this.communicationState.hudElements = hudElements;
                
                // Setup input
                this.setupCommunicationInput();
            }

            setupCommunicationInput() {
                if (this.communicationSpaceKey) {
                    this.communicationSpaceKey.off('down');
                }
                
                this.communicationSpaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                this.communicationSpaceKey.on('down', () => {
                    this.communicationState.currentIndex++;
                    this.showNextMessage();
                });
            }

            clearCommunicationHUD() {
                if (!this.communicationState || !this.communicationState.hudElements) return;

                const elements = this.communicationState.hudElements;
                elements.graphics.forEach(g => g.destroy());
                elements.texts.forEach(t => t.destroy());
                elements.images.forEach(i => i.destroy());

                this.communicationState.hudElements = null;
            }

            closeCommunication() {
                console.log('Closing communication dialog');

                this.clearCommunicationHUD();

                if (this.communicationSpaceKey) {
                    this.communicationSpaceKey.off('down');
                    this.communicationSpaceKey = null;
                }

                // Restore player ship scale
                if (this.playerShip && this.originalPlayerScaleX !== undefined) {
                    this.tweens.add({
                        targets: this.playerShip,
                        scaleX: this.originalPlayerScaleX,
                        scaleY: this.originalPlayerScaleY,
                        duration: DialogConfig.playerShip.scaleDuration,
                        ease: 'Sine.easeInOut'
                    });
                    
                    console.log(`Restoring player ship scale to ${this.originalPlayerScaleX}`);
                }

                // Call completion callback
                this.time.delayedCall(500, () => {
                    const onComplete = this.communicationState.onComplete;
                    this.communicationState = null;
                    
                    if (onComplete) {
                        onComplete();
                    }
                });
            }
        }

        // Create game config
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: document.body,
            backgroundColor: '#001122',
            scene: TestDialogScene,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        const game = new Phaser.Game(config);
    </script>
</body>
</html>
