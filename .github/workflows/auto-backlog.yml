name: AI Autonomous Backlog Generator

on:
  schedule:
    - cron: "0 14 * * *" # Daily at 9am Central Time
  workflow_dispatch: # Manual run

jobs:
  generate-tasks:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check open issues (guardrail)
        id: issue_check
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            const openCount = issues.length;
            console.log(`Open issues: ${openCount}`);

            if (openCount >= 15) {
              console.log("15 or more open issues. Skipping AI generation.");
              return "skip";
            } else {
              return "proceed";
            }

      - name: Stop if guardrail triggered
        if: steps.issue_check.outputs.result == 'skip'
        run: |
          echo "Open issue threshold reached. Skipping workflow run."
          exit 0

      - name: Build filtered repository context (text files only)
        id: context
        run: |
          echo "Building repository context..."
          find . \
            -type f \
            \( -name "*.md" -o -name "*.ts" -o -name "*.js" -o -name "*.json" -o -name "*.py" -o -name "*.yml" -o -name "*.yaml" -o -name "*.html" -o -name "*.css" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            ! -path "*/.git/*" \
            ! -path "*/coverage/*" \
            -print0 | xargs -0 cat > repo-context.txt

          # Limit to first 200 KB to reduce token cost
          head -c 200000 repo-context.txt > repo-context-limited.txt
          echo "Context file created with size: $(wc -c < repo-context-limited.txt) bytes"

      - name: Generate tasks using OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          PROMPT='You are a senior software architect.
          
          Analyze the provided repository codebase and generate 10 high-quality GitHub issues.
          
          Return ONLY valid JSON:
          [
            {
              "title": "Short actionable task title",
              "body": "Detailed description, rationale, and acceptance criteria. Mention relevant files.",
              "labels": ["enhancement"]
            }
          ]
          
          Rules:
          - Each task should be < 2 hours of work
          - Mix: refactors, tests, reliability, small features, documentation
          - Avoid duplicates
          - Be specific and practical'

          # Read context from file and escape for JSON
          CONTEXT=$(cat repo-context-limited.txt | jq -Rs .)

          # Build JSON payload
          cat > payload.json <<EOF
          {
            "model": "gpt-4o-mini",
            "temperature": 0.4,
            "messages": [
              {"role": "system", "content": "You generate precise GitHub development tasks."},
              {"role": "user", "content": $(echo "$PROMPT\n\nRepository Codebase:\n" | jq -Rs .) }
            ]
          }
          EOF

          # Add context to the user message
          jq --arg context "$(cat repo-context-limited.txt)" \
            '.messages[1].content = (.messages[1].content + "\n" + $context)' \
            payload.json > payload-final.json

          curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload-final.json | jq -r '.choices[0].message.content' > tasks.json

      - name: Create GitHub issues from generated tasks
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const raw = fs.readFileSync('tasks.json', 'utf8').trim();
            if (!raw) {
              core.setFailed("No tasks returned from model.");
              return;
            }

            let tasks;
            try {
              tasks = JSON.parse(raw);
            } catch (err) {
              core.setFailed("Invalid JSON returned:\n" + raw);
              return;
            }

            if (!Array.isArray(tasks) || tasks.length === 0) {
              core.setFailed("No valid tasks found.");
              return;
            }

            for (const task of tasks) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: task.title,
                body: task.body,
                labels: task.labels || ['ai-generated']
              });
            }